<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="calculator_controller.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/controllers/calculator_controller.rb</title>
  </head>
  <body><h1>Calculator controller to build the form and run the calculations.</h1>
<p>Individual calculations for different flavours of instrument are packaged into separate files. This code requires those files to be loaded.</p>
<code title='Line 4, app/controllers/calculator_controller.rb'><pre><a name='4'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L4'> 4</a> require 'calculations/bicameral_both_houses_sitting'
</pre></code><code title='Line 5, app/controllers/calculator_controller.rb'><pre><a name='5'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L5'> 5</a> require 'calculations/bicameral_si_either_house_sitting'
</pre></code><code title='Line 6, app/controllers/calculator_controller.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L6'> 6</a> require 'calculations/commons_only_si'
</pre></code><code title='Line 7, app/controllers/calculator_controller.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L7'> 7</a> require 'calculations/commons_only_sitting_days'
</pre></code><code title='Line 8, app/controllers/calculator_controller.rb'><pre><a name='8'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L8'> 8</a> require 'calculations/pnsi'
</pre></code><code title='Line 9, app/controllers/calculator_controller.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L9'> 9</a> require 'calculations/treaty'
</pre></code><code title='Line 10, app/controllers/calculator_controller.rb'><pre><a name='10'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L10'> 10</a> require 'calculations/interval'
</pre></code><h2>The controller itself.</h2>
<code title='Line 13, app/controllers/calculator_controller.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L13'> 13</a> class CalculatorController < ApplicationController
</pre></code><p>Include code from each of the modules for the different styles of calculation.</p>
<code title='Line 16, app/controllers/calculator_controller.rb'><pre><a name='16'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L16'> 16</a>   include CALCULATION_BICAMERAL_BOTH_HOUSES_SITTING
</pre></code><code title='Line 17, app/controllers/calculator_controller.rb'><pre><a name='17'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L17'> 17</a>   include CALCULATION_BICAMERAL_SI_EITHER_HOUSE_SITTING
</pre></code><code title='Line 18, app/controllers/calculator_controller.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L18'> 18</a>   include CALCULATION_COMMONS_ONLY_SI
</pre></code><code title='Line 19, app/controllers/calculator_controller.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L19'> 19</a>   include CALCULATION_COMMONS_ONLY_SITTING_DAYS
</pre></code><code title='Line 20, app/controllers/calculator_controller.rb'><pre><a name='20'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L20'> 20</a>   include CALCULATION_PNSI
</pre></code><code title='Line 21, app/controllers/calculator_controller.rb'><pre><a name='21'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L21'> 21</a>   include CALCULATION_TREATY
</pre></code><code title='Line 22, app/controllers/calculator_controller.rb'><pre><a name='22'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L22'> 22</a>   include CALCULATION_INTERVAL
</pre></code><h3>This is the code to provide information for the form that users can fill in.</h3>
<code title='Line 25, app/controllers/calculator_controller.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L25'> 25</a>   def index
</pre></code><p>Set a title for the page.</p>
<code title='Line 28, app/controllers/calculator_controller.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L28'> 28</a>     @title = "Calculate scrutiny periods"
</pre></code><p>Find all the active procedures in display order - to populate the procedure radio buttons on the form.</p>
<code title='Line 31, app/controllers/calculator_controller.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L31'> 31</a>     @procedures = Procedure.all.where( 'active is true' ).order( 'display_order asc')
</pre></code><code title='Line 32, app/controllers/calculator_controller.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L32'> 32</a>   end
</pre></code><h3>This is the code to provide information for the form that users wishing to run a specific calculation style can fill in.</h3>
<code title='Line 35, app/controllers/calculator_controller.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L35'> 35</a>   def style
</pre></code><p>Set a title for the page.</p>
<code title='Line 38, app/controllers/calculator_controller.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L38'> 38</a>     @title = "Calculate scrutiny periods"
</pre></code><code title='Line 39, app/controllers/calculator_controller.rb'><pre><a name='39'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L39'> 39</a>   end
</pre></code><h3>This code runs the calculation.</h3>
<code title='Line 42, app/controllers/calculator_controller.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L42'> 42</a>   def calculate
</pre></code><p>In order to calculate the scrutiny period, we need:</p>
<ul>
<li>the <strong>start date</strong>, for example: <q>2020-05-06</q></li>
</ul>
<code title='Line 47, app/controllers/calculator_controller.rb'><pre><a name='47'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L47'> 47</a>     start_date = params['start-date']
</pre></code><ul>
<li>the <strong>day count</strong> and</li>
</ul>
<code title='Line 50, app/controllers/calculator_controller.rb'><pre><a name='50'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L50'> 50</a>     day_count = params['day-count']
</pre></code><ul>
<li>either the <strong>type of the procedure</strong> itself, which we refer to by a number</li>
</ul>
<code title='Line 53, app/controllers/calculator_controller.rb'><pre><a name='53'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L53'> 53</a>     procedure = params['procedure'].to_i if params['procedure']
</pre></code><ul>
<li>or the <strong>calculation style</strong>, which we also refer to by a number</li>
</ul>
<code title='Line 56, app/controllers/calculator_controller.rb'><pre><a name='56'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L56'> 56</a>     calculation_style = params['calculation-style'].to_i if params['calculation-style']
</pre></code><p>If neither the <strong>procedure</strong>  nor the <strong>calculation style</strong> have been provided, or the <strong>start date</strong> has not been provided ...</p>
<code title='Line 59, app/controllers/calculator_controller.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L59'> 59</a>     if ( procedure.nil? and calculation_style.nil? ) or start_date.blank?
</pre></code><p>... we set an error message ...</p>
<code title='Line 62, app/controllers/calculator_controller.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L62'> 62</a> 	    @title = "Sorry, we need more information to complete the calculation"
</pre></code><p>... and display the error.</p>
<code title='Line 65, app/controllers/calculator_controller.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L65'> 65</a>       render :template => 'calculator/not_enough_information'
</pre></code><p>If the <strong>start date</strong> and either the <strong>procedure</strong> or the <strong>calculation style</strong> have been provided by the initial form, we ...</p>
<code title='Line 68, app/controllers/calculator_controller.rb'><pre><a name='68'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L68'> 68</a>     else
</pre></code><ul>
<li>make the text of the date passed into a date format</li>
</ul>
<code title='Line 71, app/controllers/calculator_controller.rb'><pre><a name='71'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L71'> 71</a>       @start_date = Date.parse( start_date )
</pre></code><h1>* find the procedure if there is one</h1>
<code title='Line 74, app/controllers/calculator_controller.rb'><pre><a name='74'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L74'> 74</a>       @procedure = Procedure.find( procedure ) if procedure
</pre></code><h1>* set the calculation style if there is one</h1>
<code title='Line 77, app/controllers/calculator_controller.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L77'> 77</a>       @calculation_style = calculation_style if calculation_style
</pre></code><p>If the day count has not been provided by the day count form or the day count is 0 ...</p>
<code title='Line 80, app/controllers/calculator_controller.rb'><pre><a name='80'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L80'> 80</a>       if day_count.blank? or day_count.to_i == 0
</pre></code><p>... we set a title for the page.</p>
<code title='Line 83, app/controllers/calculator_controller.rb'><pre><a name='83'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L83'> 83</a>     	  @title = "Calculate scrutiny period"
</pre></code><p>We render the day count form.</p>
<code title='Line 86, app/controllers/calculator_controller.rb'><pre><a name='86'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L86'> 86</a>         render :template => 'calculator/day_count_form'
</pre></code><p>If the day count has been provided by the day count form ...</p>
<code title='Line 89, app/controllers/calculator_controller.rb'><pre><a name='89'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L89'> 89</a>       else
</pre></code><p>... we set a title for the page.</p>
<code title='Line 92, app/controllers/calculator_controller.rb'><pre><a name='92'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L92'> 92</a>     	  @title = "Calculated scrutiny period"
</pre></code><p>We get the day count as an integer.</p>
<code title='Line 95, app/controllers/calculator_controller.rb'><pre><a name='95'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L95'> 95</a>         @day_count = day_count.to_i
</pre></code><p>If the procedure has been selected ...</p>
<code title='Line 98, app/controllers/calculator_controller.rb'><pre><a name='98'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L98'> 98</a>         if @procedure
</pre></code><p>To calculate the <strong>anticipated end date</strong>, we select the calculation based on the type of procedure:</p>
<code title='Line 101, app/controllers/calculator_controller.rb'><pre><a name='101'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L101'> 101</a>           case @procedure.id
</pre></code><ul>
<li>Legislative Reform Orders, Public Body Orders and Localism Orders</li>
</ul>
<code title='Line 104, app/controllers/calculator_controller.rb'><pre><a name='104'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L104'> 104</a>           when 1, 17, 18, 19, 2, 4
</pre></code><code title='Line 106, app/controllers/calculator_controller.rb'><pre><a name='106'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L106'> 106</a>             @start_date_type = "laying date"
</pre></code><code title='Line 107, app/controllers/calculator_controller.rb'><pre><a name='107'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L107'> 107</a>             @scrutiny_end_date = bicameral_calculation_both_houses_sitting( @start_date, @day_count )
</pre></code><ul>
<li>Proposed Statutory Instruments (PNSIs)</li>
</ul>
<code title='Line 110, app/controllers/calculator_controller.rb'><pre><a name='110'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L110'> 110</a>           when 3
</pre></code><code title='Line 112, app/controllers/calculator_controller.rb'><pre><a name='112'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L112'> 112</a>             @start_date_type = "laying date"
</pre></code><code title='Line 113, app/controllers/calculator_controller.rb'><pre><a name='113'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L113'> 113</a>             @scrutiny_end_date = pnsi_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Commons only negative Statutory Instruments</li>
</ul>
<code title='Line 116, app/controllers/calculator_controller.rb'><pre><a name='116'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L116'> 116</a>           when 5
</pre></code><code title='Line 118, app/controllers/calculator_controller.rb'><pre><a name='118'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L118'> 118</a>             @start_date_type = "laying date"
</pre></code><code title='Line 119, app/controllers/calculator_controller.rb'><pre><a name='119'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L119'> 119</a>             @scrutiny_end_date = commons_only_si_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Commons and Lords negative Statutory Instruments and proposed and draft affirmative remedial orders</li>
</ul>
<code title='Line 122, app/controllers/calculator_controller.rb'><pre><a name='122'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L122'> 122</a>           when 6, 13, 14
</pre></code><code title='Line 124, app/controllers/calculator_controller.rb'><pre><a name='124'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L124'> 124</a>             @start_date_type = "laying date"
</pre></code><code title='Line 125, app/controllers/calculator_controller.rb'><pre><a name='125'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L125'> 125</a>             @scrutiny_end_date = bicameral_si_either_house_sitting_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Some Commons only made affirmative Statutory Instruments</li>
</ul>
<code title='Line 128, app/controllers/calculator_controller.rb'><pre><a name='128'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L128'> 128</a>           when 7
</pre></code><code title='Line 130, app/controllers/calculator_controller.rb'><pre><a name='130'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L130'> 130</a>             @start_date_type = "making date"
</pre></code><code title='Line 131, app/controllers/calculator_controller.rb'><pre><a name='131'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L131'> 131</a>             @scrutiny_end_date = commons_only_si_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Commons and Lords made affirmative Statutory Instruments where both Houses are sitting</li>
</ul>
<code title='Line 134, app/controllers/calculator_controller.rb'><pre><a name='134'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L134'> 134</a>           when 8
</pre></code><code title='Line 136, app/controllers/calculator_controller.rb'><pre><a name='136'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L136'> 136</a>             @start_date_type = "making date"
</pre></code><code title='Line 137, app/controllers/calculator_controller.rb'><pre><a name='137'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L137'> 137</a>             @scrutiny_end_date = bicameral_calculation_both_houses_sitting( @start_date, @day_count )
</pre></code><ul>
<li>Commons and Lords made affirmative Statutory Instruments where either House is sitting and made affirmative remedial orders</li>
</ul>
<code title='Line 140, app/controllers/calculator_controller.rb'><pre><a name='140'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L140'> 140</a>           when 9, 15, 16
</pre></code><code title='Line 142, app/controllers/calculator_controller.rb'><pre><a name='142'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L142'> 142</a>             @start_date_type = "making date"
</pre></code><code title='Line 143, app/controllers/calculator_controller.rb'><pre><a name='143'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L143'> 143</a>             @scrutiny_end_date = bicameral_si_either_house_sitting_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Treaty period A</li>
</ul>
<code title='Line 146, app/controllers/calculator_controller.rb'><pre><a name='146'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L146'> 146</a>           when 10
</pre></code><code title='Line 148, app/controllers/calculator_controller.rb'><pre><a name='148'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L148'> 148</a>             @start_date_type = "laying date"
</pre></code><code title='Line 149, app/controllers/calculator_controller.rb'><pre><a name='149'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L149'> 149</a>             @scrutiny_end_date = treaty_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Treaty period B</li>
</ul>
<code title='Line 152, app/controllers/calculator_controller.rb'><pre><a name='152'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L152'> 152</a>           when 11
</pre></code><code title='Line 154, app/controllers/calculator_controller.rb'><pre><a name='154'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L154'> 154</a>             @start_date_type = "date of Ministerial statement"
</pre></code><code title='Line 155, app/controllers/calculator_controller.rb'><pre><a name='155'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L155'> 155</a>             @scrutiny_end_date = treaty_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Published drafts under the European Union (Withdrawal) Act 2018</li>
</ul>
<code title='Line 158, app/controllers/calculator_controller.rb'><pre><a name='158'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L158'> 158</a>           when 12
</pre></code><code title='Line 160, app/controllers/calculator_controller.rb'><pre><a name='160'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L160'> 160</a>             @start_date_type = "date of publication"
</pre></code><code title='Line 161, app/controllers/calculator_controller.rb'><pre><a name='161'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L161'> 161</a>             @scrutiny_end_date = bicameral_calculation_both_houses_sitting( @start_date, @day_count )
</pre></code><ul>
<li>National Policy Statements.</li>
</ul>
<code title='Line 164, app/controllers/calculator_controller.rb'><pre><a name='164'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L164'> 164</a>           when 20
</pre></code><code title='Line 166, app/controllers/calculator_controller.rb'><pre><a name='166'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L166'> 166</a>             @start_date_type = "laying date"
</pre></code><code title='Line 167, app/controllers/calculator_controller.rb'><pre><a name='167'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L167'> 167</a>             @scrutiny_end_date = commons_only_sitting_days( @start_date, @day_count )
</pre></code><code title='Line 168, app/controllers/calculator_controller.rb'><pre><a name='168'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L168'> 168</a>           end
</pre></code><p>Otherwise, if the calculation style has been selected ...</p>
<code title='Line 171, app/controllers/calculator_controller.rb'><pre><a name='171'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L171'> 171</a>         elsif @calculation_style
</pre></code><p>... to calculate the <strong>anticipated end date</strong>, we select the calculation based on the calculation style:</p>
<code title='Line 174, app/controllers/calculator_controller.rb'><pre><a name='174'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L174'> 174</a>           case @calculation_style
</pre></code><ul>
<li>Calculation style 1</li>
</ul>
<code title='Line 177, app/controllers/calculator_controller.rb'><pre><a name='177'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L177'> 177</a>           when 1
</pre></code><code title='Line 179, app/controllers/calculator_controller.rb'><pre><a name='179'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L179'> 179</a>             @scrutiny_end_date = bicameral_calculation_both_houses_sitting( @start_date, @day_count )
</pre></code><ul>
<li>Calculation style 2</li>
</ul>
<code title='Line 182, app/controllers/calculator_controller.rb'><pre><a name='182'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L182'> 182</a>           when 2
</pre></code><code title='Line 184, app/controllers/calculator_controller.rb'><pre><a name='184'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L184'> 184</a>             @scrutiny_end_date = bicameral_si_either_house_sitting_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Calculation style 3</li>
</ul>
<code title='Line 187, app/controllers/calculator_controller.rb'><pre><a name='187'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L187'> 187</a>           when 3
</pre></code><code title='Line 189, app/controllers/calculator_controller.rb'><pre><a name='189'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L189'> 189</a>             @scrutiny_end_date = commons_only_si_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Calculation style 4</li>
</ul>
<code title='Line 192, app/controllers/calculator_controller.rb'><pre><a name='192'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L192'> 192</a>           when 4
</pre></code><code title='Line 194, app/controllers/calculator_controller.rb'><pre><a name='194'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L194'> 194</a>             @scrutiny_end_date = pnsi_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Calculation style 5</li>
</ul>
<code title='Line 197, app/controllers/calculator_controller.rb'><pre><a name='197'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L197'> 197</a>           when 5
</pre></code><code title='Line 199, app/controllers/calculator_controller.rb'><pre><a name='199'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L199'> 199</a>             @scrutiny_end_date = treaty_calculation( @start_date, @day_count )
</pre></code><ul>
<li>Calculation style 6</li>
</ul>
<code title='Line 202, app/controllers/calculator_controller.rb'><pre><a name='202'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L202'> 202</a>           when 6
</pre></code><code title='Line 204, app/controllers/calculator_controller.rb'><pre><a name='204'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L204'> 204</a>             @scrutiny_end_date = commons_only_sitting_days( @start_date, @day_count )
</pre></code><code title='Line 205, app/controllers/calculator_controller.rb'><pre><a name='205'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L205'> 205</a>           end
</pre></code><code title='Line 206, app/controllers/calculator_controller.rb'><pre><a name='206'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L206'> 206</a>         end
</pre></code><code title='Line 207, app/controllers/calculator_controller.rb'><pre><a name='207'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L207'> 207</a>       end
</pre></code><code title='Line 208, app/controllers/calculator_controller.rb'><pre><a name='208'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L208'> 208</a>       @alternate_title = 'anticipated end date of the scrutiny period'
</pre></code><code title='Line 209, app/controllers/calculator_controller.rb'><pre><a name='209'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L209'> 209</a>       @json_url = request.original_fullpath.sub '?', '.json?'
</pre></code><code title='Line 210, app/controllers/calculator_controller.rb'><pre><a name='210'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L210'> 210</a>       @calendar_links = []
</pre></code><code title='Line 211, app/controllers/calculator_controller.rb'><pre><a name='211'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L211'> 211</a>       calendar_link = ['Anticipated end date of the scrutiny period', request.original_fullpath.sub( '?', '.ics?' )]
</pre></code><code title='Line 212, app/controllers/calculator_controller.rb'><pre><a name='212'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L212'> 212</a>       @calendar_links << calendar_link
</pre></code><code title='Line 213, app/controllers/calculator_controller.rb'><pre><a name='213'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L213'> 213</a>     end
</pre></code><code title='Line 214, app/controllers/calculator_controller.rb'><pre><a name='214'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L214'> 214</a>   end
</pre></code><h3>This is the code to build the interval calculation form.</h3>
<code title='Line 217, app/controllers/calculator_controller.rb'><pre><a name='217'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L217'> 217</a>   def interval
</pre></code><code title='Line 220, app/controllers/calculator_controller.rb'><pre><a name='220'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L220'> 220</a>     @title = "Calculate sitting days during an interval"
</pre></code><p>We get both Houses.</p>
<code title='Line 223, app/controllers/calculator_controller.rb'><pre><a name='223'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L223'> 223</a>     @houses = House.all
</pre></code><code title='Line 224, app/controllers/calculator_controller.rb'><pre><a name='224'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L224'> 224</a>   end
</pre></code><h3>This is the code to calculate the number of sitting days during an interval of time.</h3>
<code title='Line 227, app/controllers/calculator_controller.rb'><pre><a name='227'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L227'> 227</a>   def interval_calculate
</pre></code><p>In order to calculate the number of sitting days during an interval, we need:</p>
<ul>
<li>the <strong>start date</strong>, for example: <q>2020-05-06</q></li>
</ul>
<code title='Line 232, app/controllers/calculator_controller.rb'><pre><a name='232'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L232'> 232</a>     start_date = params['start-date']
</pre></code><ul>
<li>the <strong>end date</strong>, for example: <q>2021-04-11</q></li>
</ul>
<code title='Line 235, app/controllers/calculator_controller.rb'><pre><a name='235'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L235'> 235</a>     end_date = params['end-date']
</pre></code><p>If neither the <strong>start date</strong> nor the ** end date** has not been provided ...</p>
<code title='Line 238, app/controllers/calculator_controller.rb'><pre><a name='238'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L238'> 238</a>     if start_date.blank? or end_date.blank?
</pre></code><p>... we set an error message ...</p>
<code title='Line 241, app/controllers/calculator_controller.rb'><pre><a name='241'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L241'> 241</a> 	    @title = "Sorry, we need more information to complete the calculation"
</pre></code><p>... and display the error.</p>
<code title='Line 244, app/controllers/calculator_controller.rb'><pre><a name='244'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L244'> 244</a>       render :template => 'calculator/interval_not_enough_information'
</pre></code><p>Otherwise, if both the start date and the end date have been provided ...</p>
<code title='Line 247, app/controllers/calculator_controller.rb'><pre><a name='247'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L247'> 247</a>     else
</pre></code><p>... we set a title for the page.</p>
<code title='Line 250, app/controllers/calculator_controller.rb'><pre><a name='250'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L250'> 250</a>     	@title = "Number of sitting days within the interval"
</pre></code><p>We make the text of the start date and end date passed into date formats.</p>
<code title='Line 253, app/controllers/calculator_controller.rb'><pre><a name='253'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L253'> 253</a>       @start_date = Date.parse( start_date )
</pre></code><code title='Line 254, app/controllers/calculator_controller.rb'><pre><a name='254'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L254'> 254</a>       @end_date = Date.parse( end_date )
</pre></code><p>If the start date is the same as or after the end date ...</p>
<code title='Line 257, app/controllers/calculator_controller.rb'><pre><a name='257'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L257'> 257</a>       if @start_date >= @end_date
</pre></code><p>... we set a title for the page ...</p>
<code title='Line 260, app/controllers/calculator_controller.rb'><pre><a name='260'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L260'> 260</a>     	  @title = "Unable to calculate sitting days"
</pre></code><p>... construct an error mesage.</p>
<code title='Line 263, app/controllers/calculator_controller.rb'><pre><a name='263'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L263'> 263</a>         @error_message = "The start date must precede the end date."
</pre></code><p>... and display the error.</p>
<code title='Line 266, app/controllers/calculator_controller.rb'><pre><a name='266'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L266'> 266</a>         render :template => 'calculator/interval_error'
</pre></code><p>Otherwise, if the end date is after the start date ...</p>
<code title='Line 269, app/controllers/calculator_controller.rb'><pre><a name='269'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L269'> 269</a>       else
</pre></code><p>... we set the sitting day counts ...</p>
<code title='Line 272, app/controllers/calculator_controller.rb'><pre><a name='272'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L272'> 272</a>         @commons_sitting_day_count = 0
</pre></code><code title='Line 273, app/controllers/calculator_controller.rb'><pre><a name='273'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L273'> 273</a>         @lords_sitting_day_count = 0
</pre></code><p>... and calculate the sitting days in the interval.</p>
<code title='Line 276, app/controllers/calculator_controller.rb'><pre><a name='276'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L276'> 276</a>         calculate_sitting_days_in_interval( @start_date, @end_date )
</pre></code><code title='Line 277, app/controllers/calculator_controller.rb'><pre><a name='277'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L277'> 277</a>       end
</pre></code><code title='Line 278, app/controllers/calculator_controller.rb'><pre><a name='278'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L278'> 278</a>     end
</pre></code><code title='Line 279, app/controllers/calculator_controller.rb'><pre><a name='279'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L279'> 279</a>   end
</pre></code><code title='Line 280, app/controllers/calculator_controller.rb'><pre><a name='280'  class='githubline' href='https://github.com/ukparliament/egg-timer/tree/master/app/controllers/calculator_controller.rb#L280'> 280</a> end
</pre></code></body></html>